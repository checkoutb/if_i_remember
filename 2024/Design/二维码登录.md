二维码登录

2024-04-25 15:53

[[toc]]

---
---


# 二维码登录
bilibili

也是一种 登录认证
- 告知系统我是谁 username
- 证明我是我 password

---

## 基于token的认证模式
- 第一次，客户端发送 账号，密码，设备 给服务端
- 服务端 验证用户，绑定设备，返回 token
- 后续，客户端通过 token + 设备信息 来访问接口


## 扫码的步骤
1. 电脑端 展示二维码， 新建状态
2. 手机 扫描二维码， 电脑显示 扫码成功，待手机确认， 待确认状态
3. 手机 确认 或 拒绝， 电脑显示 结果。 已确认状态


二维码 是唯一的， 绑定了 PC的信息
手机扫描后， 原先的 二维码+PC信息，又增加了 账号信息
手机确认后， 生成PC 使用的token 告知 PC，这样就是 二维码 + PC信息 + 账号信息 + PC token


---

## 真正的流程

1. PC访问server，发送 二维码请求
2. 服务器 生成 二维码 和 PC设备 绑定，返回 二维码 给 PC
3. PC展示 二维码， 轮询二维码的状态

1. 手机 扫描 PC二维码， 获得 二维码ID
2. 手机 将 二维码ID + 账户信息 发给 server
3. server 将 账户信息 绑定到 二维码ID， 返回 ==临时token== 给 手机
  1. 二维码 和 账户已绑定，此时 PC 显示 扫码成功，待手机确认
  2. 临时 token 是为了 保证： token 绑定的是 本次的 二维码，而不是 其他的二维码。 就是 ==开多个 页面登录，手机确认的 是 哪个页面？就由 这个 临时token 确定==。
4. 手机点击 登录，使用临时 token。
5. 服务器 确认后，根据 二维码ID， 绑定 PC设备 和 账户， 生成 PC token。 修改 二维码的状态。
  1. PC一直在轮询，所以可以知道 它的 二维码的状态 是 可以登录， 且获得 token。

。。不对啊， 手机 扫码，就知道 二维码的ID 了， 不需要 临时token 啊。
。视频 原话是 确保 扫码和登录 是同一个手机， 但是我无法理解，所以改成了 手机确定的是哪个页面。
。。确实无法理解 扫码和登录 是同一个手机啊。  原先的 token 就可以 表明 是同一个手机了啊。 上面说的，token 绑定了 账号，设备。


---
## 评论

1. PC有个扫码登录选项，打开后，PC页面上展示 二维码
2. 二维码实际上就是 URL
3. 手机扫 二维码时，获得URL，发送 post请求到 这个URL，提交了 设备信息 。 。。？这步不对吧，扫码 不一定发送 URL 啊。 扫码一般是 唤醒 某个 app吧， 或者 直接 app 扫码。。 但是 唤醒app后，app会主动发送信息？ 不然的话 二维码状态 怎么改？ 但是主动发信息 有点多余啊，又没什么意义，不过可以给 用户看，用户体验好。而且 这样的话 就不会 生成 临时 token了啊。 也可以生成。 但是 直接把 二维码 id 发给服务器 不就可以了吗？二维码id 说明了 要登录哪个页面， token代表了 登录哪个账户。 所以 临时 token 毫无意义啊。
4. 服务器收到了 APP的请求，并携带了 设备信息 (。。这个设备信息要来干吗？上面有，token 是绑定了 设备信息的，所以 只发token，服务器不通过的，需要 token + 设备信息，然后服务器会根据 token 找到 服务器中保存的设备信息，如果和 请求的 设备信息 一致，那么才 ok。。而且 发请求了 必然带 token)， 发送一个生产消息状态为1 (。。不懂，感觉是 PC可以登录 的意思。。结合下面，感觉是 服务器 push的，而不是 client pull)

第一步 PC 获得二维码时， 还启动了 一个 js 定时器，如果 超时 且 服务器没有表明 有 app 确认登录，则 刷新二维码。 如果 收到了 服务器推送的 确认登录 ( 通常 会携带token， 也可能是 登录成功时 返回)，PC保存好 token 。


---
## 评论

PC根据接口 将获得的 URL 生成 二维码，这个 url 携带了一个 唯一值，
用户扫码后，根据 预先设置好的 回调接口 + 二维码的唯一值 + token 访问 回调接口， 服务器就知道 登录或取消
PC 会 使用 二维码的 唯一值 来 轮询 另一个接口。就可以知道 是否 可以登录

---
## 评论

服务收到 PC请求后， 生成 token 绑定 PC， PC的二维码中 携带了这个 token， 手机扫码后， 确认登录， 会把 二维码中的 token 发给 服务器，服务器 激活 这个token。
。。好像更简化了，不需要 二维码id， 直接就是 token。
。。评论说的 不是这个意思，估计 token 就是 二维码ID 的意思， 因为后来 他说 重新创建token 返回给 PC。
。。确实，我开了 二维码，但不登录呢？ 无限刷新， 数据库 要爆的。 将创建这个 token 的时间延后，可以减少 消耗。 也不是，可以先 redis，登录后，才放到 db中。无所谓的， token ，一个 UUID，消耗 非常非常低

---

。。还有一个问题， 手机扫码后，会知道 PC的信息，IP的地区 (上海，北京) 这些信息 是在 二维码中，还是在 扫码后， 应该扫码后吧， 不然 地址 就泄漏了，而且 把信息编码 也挺麻烦的。

。。还有，设备信息，怎么获得？包含了什么信息？
`console.log(navigator.userAgent)` "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0" 没什么用啊。

。。没有，本地可以保存一些东西啊。比如 token 的过期时间，过期了，自然就登录不了了。 还有服务器也可以保存 过期时间。
。能 hack 到token了， 那么 直接用 那台电脑登录 不就ok了。
。。啊，IP啊， 服务器保存 收到的请求的 公网IP 就可以了。 token 就和 这个 公网IP 绑一起，不过，公网IP会变。。

























