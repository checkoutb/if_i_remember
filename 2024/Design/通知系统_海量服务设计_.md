[[toc]]

---


# 如何设计一个通知系统 bilibili

https://www.bilibili.com/video/BV17T421179n


评论：
这个视频中大部分都是 海量服务设计， 里面涉及的 通知系统设计 很少。
设计的八股文： 前面 花费很少的事件 讨论下 表结构，然后 大谈：
- load balance
- mq, priority queue
- db, sharding
- cache
- notification
- scaling
- monitor

还有个评论说，图文不匹配


---

1. 功能：发送通知，通知是 邮件，短信，app短信。
2. 可扩展性
3. 可靠性

。弹幕：要批量发送，需要 服务商提供 批量api 吧。


## 数据模型

用户表，用户的基本信息
设备设置表， 以用户表id 为外键， 包含了：设备token，通知渠道(邮件/短信)，是否active
通知表， 以 通知蓝图id， userid 为外键，包含了 状态，发送时间
通知蓝图， 包含了， 蓝图名称，主题，内容，渠道

## 基础逻辑

发送通知的 请求，经过lb 到 通知服务器，通知服务器 检查 设备表，确保 用户 同意 接收信息。  
不同的渠道的通知 分发到 不同的 mq。 mq的消费者 调用第三方api 来发送 信息。


重试，可以立即重试，或者 增量时间(下次5s后，下下次1分钟后，下下下次半小时后，还不行就 死信队列) 重试。


在 ld 和 通知服务器 之间设置一个 priority queue， 根据 通知的类型来 划分优先级 ，比如 账单 类的通知 优先级最高。


分析监控服务，追踪 每条信息 从收到请求 到 发出通知的 消耗。















