[[toc]]


---


# 10万QPS 优惠券系统 - 字节团队 - bilibili

2024-9-19

https://www.bilibili.com/video/BV1nF4m1N77S

## 需求拆解

券拆分为 券模板，券记录。

- 券模板。商家要发放券，他需要定义 券的开始时间，结束时间。 券的数量。 券的类型 (满多少8折，满多少减多少，是否叠加)  。。。应该还要增加 券的开始领取时间，结束领取时间吧 (下面有提到这种检查)？
- 券记录。用户获得券后，服务端需要进行记录。 记录 券的有效时间，券模板的id，券的状态。。 应该还要 用户id，领取时间。

需要进行 库存控制，券过期时间控制

## 系统选型

mysql 存储 券模板，券记录  
redis 降低mysql压力， 券模板是只读的。 库存的扣减  
rocketmq 处理券的过期，rocketmq支持延时消息


## 系统设计与编码

领券过程
1. 收到用户的请求
2. 检查参数： 用户id，业务id，券批次号(。券id)，券领取方式 必填。
3. 校验 券批次号 是否正确 (。在redis，数据库中是否存在)
4. 检查 券批次号 可领取时间
5. 生成订单数据，非正式写入
6. 库存处理
7. 券记录，券发放记录(。这个应该就是券记录的一部分(，应该要记录，用户id，领取时间等))，写入数据库
8. 完成

瓶颈
- 库存处理的 redis 无法支持 10w qps
- 券记录 写入到数据库 无法支持 10w qps


## 解决方案

对mysql水平扩容，写入的时候 写到不同的数据库。  

。。这里感觉不对劲。后面的有所调整

数据库方面
1. 多台物理机，各装一个 mysql 实例。  
2. 根据 userid 将不同 用户的 写请求 发送到不同的 mysql。
3. 为 第一步中的 mysql 建立 从库。
4. 读取 是从 从库中读取。 ( 多个从库，就 随机/加权 之类的 lb)

redis方面 和 数据库方面一样， 也是根据 userid 将 不同用户的请求 分配到 不同的redis。每个redis实例 都增加从库 (。 redis 集群)。

。券模板 占用的内存 是非常小的， 每个redis 冗余一份，完全没有问题的。


redis 库存的扣减， 预先设置 一个随机的数组，里面是 扣减的redis的顺序， 比如 {1234,4321,2314,...}   
将库存 分散到 4个redis实例中， 每个redis实例 保存 四分之一的库存， 根据请求的id 或用户id， 映射数组中的元素， 比如 2314， 根据 2314的顺序，先从 2号redis扣减，不成功就 3号，不成功就1号，不成功就4号。   
。。最好记录下，如果 2号没有 库存了，那么后续的 请求 直接跳过 2号库存。
。。这不就是 随机选择一个，然后 剩下的里面 再随机选择一个 吗。。 是否需要 数组呢？ 应该还是需要的， 随机 的消耗也挺大的。



------------











































































































